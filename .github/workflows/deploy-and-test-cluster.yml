name: Deploy and Test Cluster

on:
  push:
    branches: [main]
    paths:
      - 'k8s/**'
  pull_request:
    branches: [main]
    paths:
      - 'k8s/**'
  workflow_dispatch:

jobs:
  deploy-and-test-cluster:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install KIND (no auto-create, no auto-delete)
        uses: helm/kind-action@v1
        with:
          install_only: true

      - name: Create KIND cluster manually (this stays!)
        run: |
          kind create cluster --name petclinic-cluster

      - name: Verify cluster
        run: |
          kind get clusters
          kubectl get nodes

      - name: Deploy applications
        run: |
          kubectl apply -f k8s/

      - name: Wait for pods
        run: |
          kubectl wait --for=condition=ready pod -l app=demo-db --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=petclinic --timeout=180s || true

      - name: Debug pods
        run: kubectl get pods -A
